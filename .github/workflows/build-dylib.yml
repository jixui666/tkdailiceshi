name: Build iOS Dylib

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build:
    runs-on: macos-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
    
    - name: Install Dependencies
      run: |
        # å®‰è£…å¿…è¦å·¥å…·
        brew install ldid dpkg
        
    - name: Show Environment Info
      run: |
        echo "=== Environment Information ==="
        xcodebuild -version
        xcrun --show-sdk-path --sdk iphoneos
        clang --version
        
        echo "=== Project Structure ==="
        ls -la
        find æ¨¡æ‹Ÿè¿”å› -type f
        
    - name: Build Dylib with Clang
      run: |
        echo "=== Building dylib with clang ==="
        
        # è·å–iOS SDKè·¯å¾„
        IOS_SDK=$(xcrun --show-sdk-path --sdk iphoneos)
        echo "iOS SDK Path: $IOS_SDK"
        
        # åˆ›å»ºè¾“å‡ºç›®å½•
        mkdir -p ./output
        
        # ç›´æ¥ä½¿ç”¨clangç¼–è¯‘dylib
        clang -arch arm64 \
              -dynamiclib \
              -isysroot "$IOS_SDK" \
              -mios-version-min=12.0 \
              -framework Foundation \
              -framework UIKit \
              -framework AVFoundation \
              -lz \
              -fobjc-arc \
              -Xlinker -install_name \
              -Xlinker /Library/MobileSubstrate/DynamicLibraries/1212.dylib \
              -o ./output/1212.dylib \
              æ¨¡æ‹Ÿè¿”å›/wyURLProtocol.m
        
        # æ£€æŸ¥ç¼–è¯‘ç»“æœ
        if [ -f "./output/1212.dylib" ]; then
          echo "âœ… Compilation successful!"
          
          # æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
          ls -la ./output/1212.dylib
          file ./output/1212.dylib
          
          # æ˜¾ç¤ºdylibæ¶æ„ä¿¡æ¯
          lipo -info ./output/1212.dylib || echo "lipo info not available"
          
          # ç­¾ådylib
          echo "=== Signing dylib ==="
          ldid -S ./output/1212.dylib
          echo "âœ… Dylib signed successfully"
          
        else
          echo "âŒ Compilation failed"
          exit 1
        fi
    
    - name: Create Deb Package
      run: |
        echo "=== Creating deb package ==="
        
        if [ -f "./output/1212.dylib" ] && [ -d "BylibKjc/Package" ]; then
          # å‡†å¤‡åŒ…ç›®å½•ç»“æ„
          mkdir -p BylibKjc/Package/Library/MobileSubstrate/DynamicLibraries/
          
          # å¤åˆ¶dylibåˆ°åŒ…ç›®å½•
          cp ./output/1212.dylib BylibKjc/Package/Library/MobileSubstrate/DynamicLibraries/
          
          # æ˜¾ç¤ºåŒ…ç»“æ„
          echo "Package structure:"
          find BylibKjc/Package -type f
          
          # æ£€æŸ¥controlæ–‡ä»¶
          if [ -f "BylibKjc/Package/DEBIAN/control" ]; then
            echo "Control file content:"
            cat BylibKjc/Package/DEBIAN/control
          else
            echo "âš ï¸ Warning: No control file found"
          fi
          
          # åˆ›å»ºdebåŒ…
          dpkg-deb -Zgzip -b BylibKjc/Package ./output/1212.deb
          
          if [ -f "./output/1212.deb" ]; then
            echo "âœ… Deb package created successfully"
            ls -la ./output/1212.deb
            
            # æ˜¾ç¤ºdebåŒ…ä¿¡æ¯
            dpkg-deb -I ./output/1212.deb || echo "deb info unavailable"
          else
            echo "âŒ Failed to create deb package"
          fi
        else
          echo "âŒ Cannot create deb package: missing dylib or package structure"
        fi
    
    - name: Verify Build Results
      run: |
        echo "=== Final Build Results ==="
        ls -la ./output/
        
        echo "=== Dylib Verification ==="
        if [ -f "./output/1212.dylib" ]; then
          echo "âœ… 1212.dylib: $(file ./output/1212.dylib)"
          echo "Size: $(ls -lh ./output/1212.dylib | awk '{print $5}')"
          
          # å°è¯•è·å–æ›´å¤šä¿¡æ¯
          otool -L ./output/1212.dylib 2>/dev/null || echo "otool not available"
        else
          echo "âŒ 1212.dylib not found"
        fi
        
        echo "=== Deb Package Verification ==="
        if [ -f "./output/1212.deb" ]; then
          echo "âœ… 1212.deb: $(file ./output/1212.deb)"
          echo "Size: $(ls -lh ./output/1212.deb | awk '{print $5}')"
        else
          echo "âŒ 1212.deb not found"
        fi
    
    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: iOS-Dylib-Build-${{ github.run_number }}
        path: |
          ./output/1212.dylib
          ./output/1212.deb
        retention-days: 30
    
    - name: Create Release
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ github.run_number }}
        name: Release v${{ github.run_number }}
        body: |
          ğŸš€ è‡ªåŠ¨æ„å»ºçš„iOS Dylibæ–‡ä»¶
          
          ## ğŸ“± æ–‡ä»¶è¯´æ˜
          - `1212.dylib`: ç¼–è¯‘å¥½çš„åŠ¨æ€åº“æ–‡ä»¶ (arm64æ¶æ„)
          - `1212.deb`: Cydiaå®‰è£…åŒ…
          
          ## âœ¨ åŠŸèƒ½ç‰¹æ€§
          - URLæ‹¦æˆªå’Œé‡å®šå‘ (wyURLProtocol)
          - æ”¯æŒiOS 12.0+
          - ä½¿ç”¨Clangç›´æ¥ç¼–è¯‘
          - æ— éœ€MonkeyDev/Theosç¯å¢ƒ
          
          ## ğŸ“¥ å®‰è£…æ–¹æ³•
          
          ### æ–¹æ³•ä¸€ï¼šå®‰è£…debåŒ… (æ¨è)
          ```bash
          # ä¸‹è½½å¹¶å®‰è£…
          dpkg -i 1212.deb
          
          # é‡å¯SpringBoard
          killall -9 SpringBoard
          ```
          
          ### æ–¹æ³•äºŒï¼šæ‰‹åŠ¨å®‰è£…dylib
          ```bash
          # å¤åˆ¶åˆ°ç›®æ ‡ç›®å½•
          cp 1212.dylib /Library/MobileSubstrate/DynamicLibraries/
          
          # é‡å¯SpringBoard
          killall -9 SpringBoard
          ```
          
          ## ğŸ”§ æŠ€æœ¯ç»†èŠ‚
          - **æ¶æ„**: arm64
          - **æœ€ä½iOSç‰ˆæœ¬**: 12.0
          - **ä¾èµ–æ¡†æ¶**: Foundation, UIKit, AVFoundation
          - **ç¼–è¯‘å™¨**: Clang (Xcode)
          - **ç­¾åå·¥å…·**: ldid
          
          ## âš™ï¸ æ„å»ºä¿¡æ¯
          - æ„å»ºæ—¶é—´: ${{ github.event.head_commit.timestamp }}
          - æäº¤SHA: ${{ github.sha }}
          - æ„å»ºç¼–å·: #${{ github.run_number }}
        files: |
          ./output/1212.dylib
          ./output/1212.deb
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} 