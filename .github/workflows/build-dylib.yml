name: Build iOS Dylib

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build:
    runs-on: macos-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
    
    - name: Install Dependencies
      run: |
        # å®‰è£…ç­¾åå·¥å…·
        brew install ldid
        
        # å®‰è£…dpkg-debç”¨äºåˆ›å»ºdebåŒ…
        brew install dpkg
        
    - name: Debug Project Structure
      run: |
        echo "=== Project Structure ==="
        ls -la
        echo "=== Xcode Project Info ==="
        xcodebuild -list -project 654323.xcodeproj || echo "Failed to list project info"
        echo "=== Available Schemes ==="
        xcodebuild -project 654323.xcodeproj -list || echo "No schemes found"
        
    - name: Setup Build Environment
      run: |
        # åˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„
        sudo mkdir -p /opt/theos
        sudo chown -R $(whoami) /opt/theos
        
        # ä¸‹è½½iOS SDK (ä½¿ç”¨è¾ƒå°çš„SDK)
        echo "Downloading iOS SDK..."
        curl -LO https://github.com/theos/sdks/archive/master.zip
        unzip master.zip
        mkdir -p /opt/theos/sdks
        cp -r sdks-master/* /opt/theos/sdks/
        
        # æ˜¾ç¤ºå¯ç”¨çš„SDK
        echo "Available SDKs:"
        ls -la /opt/theos/sdks/
        
        # è®¾ç½®ç¯å¢ƒå˜é‡
        echo "THEOS=/opt/theos" >> $GITHUB_ENV
        echo "/opt/theos/bin" >> $GITHUB_PATH
        
    - name: Build Project
      run: |
        # æ˜¾ç¤ºXcodeç‰ˆæœ¬ä¿¡æ¯
        echo "=== Xcode Version ==="
        xcodebuild -version
        
        # æ˜¾ç¤ºå¯ç”¨çš„SDK
        echo "=== Available iOS SDKs ==="
        xcodebuild -showsdks | grep iOS
        
        # æ¸…ç†é¡¹ç›®
        echo "=== Cleaning Project ==="
        xcodebuild clean -project 654323.xcodeproj -scheme 1212 || echo "Clean failed, continuing..."
        
        # å°è¯•ä¸åŒçš„æ„å»ºæ–¹æ³•
        echo "=== Building Project (Method 1: with scheme) ==="
        xcodebuild -project 654323.xcodeproj \
                   -scheme 1212 \
                   -configuration Release \
                   -derivedDataPath ./build \
                   -destination "generic/platform=iOS" \
                   IPHONEOS_DEPLOYMENT_TARGET=12.0 \
                   CODE_SIGNING_ALLOWED=NO \
                   CODE_SIGN_IDENTITY="" \
                   PROVISIONING_PROFILE="" \
                   ARCHS="arm64" \
                   VALID_ARCHS="arm64" \
                   build || {
          echo "Method 1 failed, trying Method 2..."
          
          echo "=== Building Project (Method 2: target based) ==="
          xcodebuild -project 654323.xcodeproj \
                     -target 1212 \
                     -configuration Release \
                     -derivedDataPath ./build \
                     IPHONEOS_DEPLOYMENT_TARGET=12.0 \
                     CODE_SIGNING_ALLOWED=NO \
                     CODE_SIGN_IDENTITY="" \
                     PROVISIONING_PROFILE="" \
                     ARCHS="arm64" \
                     VALID_ARCHS="arm64" \
                     build || {
            echo "Method 2 failed, trying Method 3..."
            
            echo "=== Building Project (Method 3: simple build) ==="
            xcodebuild -project 654323.xcodeproj \
                       -configuration Release \
                       IPHONEOS_DEPLOYMENT_TARGET=12.0 \
                       CODE_SIGNING_ALLOWED=NO \
                       build || {
              echo "All build methods failed, showing detailed error info..."
              echo "=== Build Directory Contents ==="
              find . -name "*.log" -exec cat {} \;
              exit 1
            }
          }
        }
    
    - name: Package Dylib
      run: |
        # æŸ¥æ‰¾ç”Ÿæˆçš„dylibæ–‡ä»¶
        echo "=== Looking for dylib files ==="
        find . -name "*.dylib" -type f || echo "No dylib files found"
        
        # æ˜¾ç¤ºå®Œæ•´çš„buildç›®å½•ç»“æ„
        echo "=== Complete Build Directory Structure ==="
        find ./build -type f 2>/dev/null | head -50 || echo "Build directory not found"
        
        # ä¹Ÿæ£€æŸ¥å½“å‰ç›®å½•ä¸‹çš„æ„å»ºäº§ç‰©
        echo "=== Current Directory Build Products ==="
        find . -name "*.dylib" -o -name "*.a" -o -name "*.framework" | head -20
        
        # åˆ›å»ºè¾“å‡ºç›®å½•
        mkdir -p ./output
        
        # å°è¯•å¤šä¸ªå¯èƒ½çš„è·¯å¾„æ¥æ‰¾åˆ°dylibæ–‡ä»¶
        DYLIB_PATH=""
        
        # å¯èƒ½çš„è·¯å¾„åˆ—è¡¨
        POSSIBLE_PATHS=(
          "./build/Build/Products/Release-iphoneos/1212.dylib"
          "./build/Build/Products/Release/1212.dylib"
          "./build/Release-iphoneos/1212.dylib"
          "./build/Release/1212.dylib"
          "./Release-iphoneos/1212.dylib"
          "./Release/1212.dylib"
        )
        
        for path in "${POSSIBLE_PATHS[@]}"; do
          if [ -f "$path" ]; then
            DYLIB_PATH="$path"
            echo "Found dylib at: $DYLIB_PATH"
            break
          fi
        done
        
        # å¦‚æœè¿˜æ²¡æ‰¾åˆ°ï¼Œå°è¯•é€šè¿‡findå‘½ä»¤æŸ¥æ‰¾
        if [ -z "$DYLIB_PATH" ]; then
          DYLIB_PATH=$(find . -name "*.dylib" -type f | head -1)
        fi
        
        if [ -n "$DYLIB_PATH" ] && [ -f "$DYLIB_PATH" ]; then
          echo "âœ… Successfully found dylib at: $DYLIB_PATH"
          cp "$DYLIB_PATH" ./output/1212.dylib
          
          # æ˜¾ç¤ºdylibæ–‡ä»¶ä¿¡æ¯
          echo "=== Dylib File Info ==="
          ls -la "$DYLIB_PATH"
          file "$DYLIB_PATH"
          
          # ç­¾ådylibæ–‡ä»¶
          echo "=== Signing dylib ==="
          ldid -S ./output/1212.dylib
          
          # åˆ›å»ºdebåŒ…
          if [ -d "BylibKjc/Package" ]; then
            echo "=== Creating deb package ==="
            # ç¡®ä¿ç›®æ ‡ç›®å½•å­˜åœ¨
            mkdir -p BylibKjc/Package/Library/MobileSubstrate/DynamicLibraries/
            cp ./output/1212.dylib BylibKjc/Package/Library/MobileSubstrate/DynamicLibraries/
            
            # æ˜¾ç¤ºåŒ…ç»“æ„
            echo "Package structure:"
            find BylibKjc/Package -type f
            
            # åˆ›å»ºdebåŒ…
            dpkg-deb -Zgzip -b BylibKjc/Package ./output/BylibKjc.deb
            
            echo "âœ… Deb package created successfully"
          fi
          
          # æ˜¾ç¤ºæœ€ç»ˆè¾“å‡ºæ–‡ä»¶
          echo "=== Final Output Files ==="
          ls -la ./output/
          
        else
          echo "âŒ Error: Could not find dylib file"
          echo "=== Debug Information ==="
          echo "Searched paths:"
          for path in "${POSSIBLE_PATHS[@]}"; do
            echo "  $path - $([ -f "$path" ] && echo "EXISTS" || echo "NOT FOUND")"
          done
          echo "=== All .dylib files in project ==="
          find . -name "*.dylib" -type f || echo "No dylib files found anywhere"
          echo "=== All files in build directory ==="
          find ./build -type f 2>/dev/null || echo "Build directory not accessible"
          exit 1
        fi
    
    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: iOS-Dylib-Build-${{ github.run_number }}
        path: |
          ./output/1212.dylib
          ./output/BylibKjc.deb
        retention-days: 30
    
    - name: Create Release
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ github.run_number }}
        name: Release v${{ github.run_number }}
        body: |
          ğŸš€ è‡ªåŠ¨æ„å»ºçš„iOS Dylibæ–‡ä»¶
          
          ## ğŸ“± æ–‡ä»¶è¯´æ˜
          - `1212.dylib`: ç¼–è¯‘å¥½çš„åŠ¨æ€åº“æ–‡ä»¶ (æ”¯æŒarm64)
          - `BylibKjc.deb`: Cydiaå®‰è£…åŒ…
          
          ## ğŸ“¥ å®‰è£…æ–¹æ³•
          
          ### æ–¹æ³•ä¸€ï¼šå®‰è£…debåŒ…
          1. ä¸‹è½½ `BylibKjc.deb` æ–‡ä»¶
          2. ä½¿ç”¨Filzaæˆ–SSHä¼ è¾“åˆ°è®¾å¤‡
          3. è¿è¡Œ `dpkg -i BylibKjc.deb` å®‰è£…
          
          ### æ–¹æ³•äºŒï¼šæ‰‹åŠ¨å®‰è£…dylib
          1. ä¸‹è½½ `1212.dylib` æ–‡ä»¶
          2. å¤åˆ¶åˆ° `/Library/MobileSubstrate/DynamicLibraries/`
          3. é‡å¯SpringBoard
          
          ## âš™ï¸ æ„å»ºä¿¡æ¯
          - æ„å»ºæ—¶é—´: ${{ github.event.head_commit.timestamp }}
          - æäº¤SHA: ${{ github.sha }}
          - iOSéƒ¨ç½²ç›®æ ‡: 12.0+
          - æ¶æ„æ”¯æŒ: arm64
        files: |
          ./output/1212.dylib
          ./output/BylibKjc.deb
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} 