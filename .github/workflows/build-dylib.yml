name: Build iOS Dylib

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build:
    runs-on: macos-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
    
    - name: Install Dependencies
      run: |
        # å®‰è£…å¿…è¦å·¥å…·
        brew install ldid dpkg make
        
    - name: Setup Theos
      run: |
        # ä¸‹è½½å¹¶å®‰è£…Theos
        echo "=== Installing Theos ==="
        sudo git clone --recursive https://github.com/theos/theos.git /opt/theos
        sudo chown -R $(whoami) /opt/theos
        
        # ä¸‹è½½iOS SDK
        echo "=== Downloading iOS SDK ==="
        curl -LO https://github.com/theos/sdks/archive/master.zip
        unzip master.zip
        cp -r sdks-master/* /opt/theos/sdks/
        
        # è®¾ç½®ç¯å¢ƒå˜é‡
        echo "THEOS=/opt/theos" >> $GITHUB_ENV
        echo "/opt/theos/bin" >> $GITHUB_PATH
        
        # æ˜¾ç¤ºTheosä¿¡æ¯
        echo "=== Theos Setup Complete ==="
        ls -la /opt/theos/
        ls -la /opt/theos/sdks/
    
    - name: Create Theos Makefile
      run: |
        # ä¸ºé¡¹ç›®åˆ›å»ºMakefile
        cat > Makefile << 'EOF'
        ARCHS = arm64
        TARGET = iphone:clang:16.5:12.0
        
        include $(THEOS)/makefiles/common.mk
        
        TWEAK_NAME = 1212
        
        1212_FILES = æ¨¡æ‹Ÿè¿”å›/wyURLProtocol.m
        1212_FRAMEWORKS = UIKit Foundation AVFoundation
        1212_LIBRARIES = z
        1212_CFLAGS = -fobjc-arc
        
        include $(THEOS)/makefiles/tweak.mk
        
        after-install::
        	install.exec "killall -9 SpringBoard"
        EOF
        
        echo "=== Generated Makefile ==="
        cat Makefile
    
    - name: Build with Theos
      run: |
        echo "=== Building with Theos ==="
        export THEOS=/opt/theos
        export PATH="/opt/theos/bin:$PATH"
        
        # æ˜¾ç¤ºç¯å¢ƒä¿¡æ¯
        echo "THEOS: $THEOS"
        echo "PATH: $PATH"
        which make
        
        # æ¸…ç†å¹¶æ„å»º
        make clean || echo "Clean failed, continuing..."
        make package DEBUG=0
        
        echo "=== Build completed ==="
        
        # æŸ¥æ‰¾ç”Ÿæˆçš„æ–‡ä»¶
        echo "=== Looking for build products ==="
        find . -name "*.dylib" -o -name "*.deb" | head -10
        
        # æ˜¾ç¤º.theosç›®å½•å†…å®¹
        echo "=== .theos directory ==="
        find .theos -type f 2>/dev/null | head -20 || echo ".theos not found"
    
    - name: Package Results
      run: |
        # åˆ›å»ºè¾“å‡ºç›®å½•
        mkdir -p ./output
        
        # æŸ¥æ‰¾dylibæ–‡ä»¶
        DYLIB_PATH=""
        if [ -f ".theos/obj/debug/1212.dylib" ]; then
          DYLIB_PATH=".theos/obj/debug/1212.dylib"
        elif [ -f ".theos/obj/1212.dylib" ]; then
          DYLIB_PATH=".theos/obj/1212.dylib"
        else
          DYLIB_PATH=$(find .theos -name "*.dylib" -type f | head -1)
        fi
        
        if [ -n "$DYLIB_PATH" ] && [ -f "$DYLIB_PATH" ]; then
          echo "âœ… Found dylib at: $DYLIB_PATH"
          cp "$DYLIB_PATH" ./output/1212.dylib
          
          # æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
          echo "=== Dylib Info ==="
          ls -la "$DYLIB_PATH"
          file "$DYLIB_PATH"
          
          # ç­¾ådylib
          ldid -S ./output/1212.dylib
          echo "âœ… Dylib signed successfully"
        else
          echo "âŒ No dylib found, trying alternative approach..."
          
          # å°è¯•æ‰‹åŠ¨ç¼–è¯‘
          echo "=== Manual compilation ==="
          clang -arch arm64 \
                -dynamiclib \
                -isysroot $(xcrun --show-sdk-path --sdk iphoneos) \
                -mios-version-min=12.0 \
                -framework Foundation \
                -framework UIKit \
                -framework AVFoundation \
                -lz \
                -fobjc-arc \
                -o ./output/1212.dylib \
                æ¨¡æ‹Ÿè¿”å›/wyURLProtocol.m
          
          if [ -f "./output/1212.dylib" ]; then
            echo "âœ… Manual compilation successful"
            ldid -S ./output/1212.dylib
          else
            echo "âŒ Manual compilation failed"
            exit 1
          fi
        fi
        
        # æŸ¥æ‰¾debåŒ…
        DEB_PATH=$(find . -name "*.deb" -type f | head -1)
        if [ -n "$DEB_PATH" ] && [ -f "$DEB_PATH" ]; then
          echo "âœ… Found deb package: $DEB_PATH"
          cp "$DEB_PATH" ./output/1212.deb
        else
          echo "âš ï¸ No deb package found, creating manual package..."
          
          # æ‰‹åŠ¨åˆ›å»ºdebåŒ…
          if [ -d "BylibKjc/Package" ] && [ -f "./output/1212.dylib" ]; then
            mkdir -p BylibKjc/Package/Library/MobileSubstrate/DynamicLibraries/
            cp ./output/1212.dylib BylibKjc/Package/Library/MobileSubstrate/DynamicLibraries/
            
            # åˆ›å»ºdebåŒ…
            dpkg-deb -Zgzip -b BylibKjc/Package ./output/1212.deb
            echo "âœ… Manual deb package created"
          fi
        fi
        
        # æ˜¾ç¤ºæœ€ç»ˆç»“æœ
        echo "=== Final Output ==="
        ls -la ./output/
        
        # éªŒè¯æ–‡ä»¶
        if [ -f "./output/1212.dylib" ]; then
          echo "âœ… dylib file ready"
          file ./output/1212.dylib
        fi
        
        if [ -f "./output/1212.deb" ]; then
          echo "âœ… deb package ready"
          dpkg-deb -I ./output/1212.deb || echo "deb info unavailable"
        fi
    
    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: iOS-Dylib-Build-${{ github.run_number }}
        path: |
          ./output/1212.dylib
          ./output/1212.deb
        retention-days: 30
    
    - name: Create Release
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ github.run_number }}
        name: Release v${{ github.run_number }}
        body: |
          ğŸš€ è‡ªåŠ¨æ„å»ºçš„iOS Dylibæ–‡ä»¶
          
          ## ğŸ“± æ–‡ä»¶è¯´æ˜
          - `1212.dylib`: ç¼–è¯‘å¥½çš„åŠ¨æ€åº“æ–‡ä»¶ (æ”¯æŒarm64)
          - `1212.deb`: Cydiaå®‰è£…åŒ…
          
          ## âœ¨ åŠŸèƒ½ç‰¹æ€§
          - URLæ‹¦æˆªå’Œé‡å®šå‘
          - æ”¯æŒiOS 12.0+
          - ä½¿ç”¨Theosæ„å»ºç³»ç»Ÿ
          
          ## ğŸ“¥ å®‰è£…æ–¹æ³•
          
          ### æ–¹æ³•ä¸€ï¼šå®‰è£…debåŒ… (æ¨è)
          1. ä¸‹è½½ `1212.deb` æ–‡ä»¶
          2. ä½¿ç”¨Filzaæˆ–SSHä¼ è¾“åˆ°è®¾å¤‡
          3. è¿è¡Œ `dpkg -i 1212.deb` å®‰è£…
          4. é‡å¯SpringBoard: `killall -9 SpringBoard`
          
          ### æ–¹æ³•äºŒï¼šæ‰‹åŠ¨å®‰è£…dylib
          1. ä¸‹è½½ `1212.dylib` æ–‡ä»¶
          2. å¤åˆ¶åˆ° `/Library/MobileSubstrate/DynamicLibraries/`
          3. é‡å¯SpringBoard
          
          ## âš™ï¸ æ„å»ºä¿¡æ¯
          - æ„å»ºæ—¶é—´: ${{ github.event.head_commit.timestamp }}
          - æäº¤SHA: ${{ github.sha }}
          - iOSéƒ¨ç½²ç›®æ ‡: 12.0+
          - æ¶æ„æ”¯æŒ: arm64
          - æ„å»ºå·¥å…·: Theos + Clang
        files: |
          ./output/1212.dylib
          ./output/1212.deb
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} 