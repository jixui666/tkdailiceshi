name: Fix TikTok ITMS Issues

on:
  workflow_dispatch:
    inputs:
      ipa_url:
        description: 'IPAæ–‡ä»¶ä¸‹è½½é“¾æ¥ (å¯é€‰ï¼Œå¦‚æœä»“åº“ä¸­æœ‰Payloadæ–‡ä»¶å¤¹åˆ™ç•™ç©º)'
        required: false
        type: string
      fix_encryption:
        description: 'ä¿®å¤åŠ å¯†é—®é¢˜'
        required: false
        default: true
        type: boolean
      fix_pie:
        description: 'ä¿®å¤PIEé—®é¢˜'
        required: false
        default: true
        type: boolean
      create_ipa:
        description: 'åˆ›å»ºä¿®å¤åçš„IPA'
        required: false
        default: true
        type: boolean
  push:
    branches: [ main, master ]

permissions:
  contents: read
  actions: read

jobs:
  fix-itms-issues:
    runs-on: macos-latest
    timeout-minutes: 30
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
      
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: 'latest-stable'

    - name: Install Dependencies with Retry
      run: |
        set -e
        
        # å®‰è£…Pythonä¾èµ– - æ·»åŠ é‡è¯•æœºåˆ¶
        echo "å®‰è£…Pythonä¾èµ–..."
        for i in {1..3}; do
          if pip install --upgrade pip setuptools wheel; then
            echo "âœ… pipå‡çº§æˆåŠŸ"
            break
          else
            echo "âš ï¸ pipå‡çº§å¤±è´¥ï¼Œç¬¬ $i æ¬¡é‡è¯•..."
            sleep 5
          fi
        done
        
        # å®‰è£…Xcodeå‘½ä»¤è¡Œå·¥å…·
        echo "æ£€æŸ¥Xcodeå‘½ä»¤è¡Œå·¥å…·..."
        xcode-select --install 2>/dev/null || echo "Xcodeå‘½ä»¤è¡Œå·¥å…·å·²å®‰è£…"
        
        # å°è¯•å®‰è£…optool - å¦‚æœå¤±è´¥å°±ç»§ç»­
        echo "å°è¯•å®‰è£…optool..."
        brew install optool 2>/dev/null || echo "âš ï¸ optoolå®‰è£…å¤±è´¥ï¼Œå°†ä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ"
        
        # éªŒè¯å·¥å…·
        echo "éªŒè¯å·¥å…·å®‰è£…..."
        python3 --version
        which codesign || echo "codesign not found"
        which otool || echo "otool not found"  
        which optool || echo "optool not found - å°†ä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ"
        which PlistBuddy || echo "PlistBuddy not found"

    - name: Download IPA (if URL provided)
      if: ${{ github.event.inputs.ipa_url != '' }}
      run: |
        echo "ä¸‹è½½IPAæ–‡ä»¶: ${{ github.event.inputs.ipa_url }}"
        curl -L -o TikTok.ipa "${{ github.event.inputs.ipa_url }}"
        unzip TikTok.ipa
        ls -la

    - name: Check Payload Directory
      run: |
        echo "æ£€æŸ¥Payloadç›®å½•..."
        if [ -d "Payload" ]; then
          echo "âœ… æ‰¾åˆ°Payloadç›®å½•"
          ls -la Payload/
          if [ -d "Payload/TikTok.app" ]; then
            echo "âœ… æ‰¾åˆ°TikTok.app"
            ls -la "Payload/TikTok.app/" | head -20
          else
            echo "âŒ æœªæ‰¾åˆ°TikTok.app"
            exit 1
          fi
        else
          echo "âŒ æœªæ‰¾åˆ°Payloadç›®å½•"
          echo "å½“å‰ç›®å½•å†…å®¹:"
          ls -la
          exit 1
        fi

    - name: Backup Original Files
      run: |
        echo "å¤‡ä»½åŸå§‹æ–‡ä»¶..."
        cp -r Payload Payload_backup
        echo "âœ… å¤‡ä»½å®Œæˆ"

    - name: Fix Info.plist (ITMS-90208)
      run: |
        echo "ä¿®å¤Info.plistä¸­çš„æœ€å°OSç‰ˆæœ¬..." | tee -a fix_process.log
        INFO_PLIST="Payload/TikTok.app/Info.plist"
        
        if [ -f "$INFO_PLIST" ]; then
          # ä½¿ç”¨Pythonå¤„ç†plistæ–‡ä»¶
          python3 << 'EOF' | tee -a fix_process.log
import plistlib
import sys

try:
    # è¯»å–plistæ–‡ä»¶
    with open('Payload/TikTok.app/Info.plist', 'rb') as f:
        plist_data = plistlib.load(f)
    
    # è·å–å½“å‰ç‰ˆæœ¬
    current_version = plist_data.get('MinimumOSVersion', 'æœªè®¾ç½®')
    print(f'å½“å‰MinimumOSVersion: {current_version}')
    
    # è®¾ç½®ä¸º14.0
    plist_data['MinimumOSVersion'] = '14.0'
    
    # å†™å›æ–‡ä»¶
    with open('Payload/TikTok.app/Info.plist', 'wb') as f:
        plistlib.dump(plist_data, f)
    
    print('âœ… å·²æ›´æ–°MinimumOSVersionä¸º: 14.0')
    
except Exception as e:
    print(f'âŒ å¤„ç†Info.plistå¤±è´¥: {e}')
    sys.exit(1)
EOF
        else
          echo "âŒ æœªæ‰¾åˆ°Info.plistæ–‡ä»¶" | tee -a fix_process.log
        fi

    - name: Run Python Fix Script
      run: |
        echo "è¿è¡ŒPythonä¿®å¤è„šæœ¬..."
        if [ -f "fix_itms_issues.py" ]; then
          python3 fix_itms_issues.py \
            --payload-dir "Payload" \
            --fix-encryption=${{ github.event.inputs.fix_encryption }} \
            --fix-pie=${{ github.event.inputs.fix_pie }} \
            --create-ipa=${{ github.event.inputs.create_ipa }} \
            --verbose
        else
          echo "âš ï¸ Pythonä¿®å¤è„šæœ¬ä¸å­˜åœ¨ï¼Œè·³è¿‡æ­¤æ­¥éª¤"
        fi

    - name: Run Shell Fix Script
      run: |
        echo "è¿è¡ŒShellä¿®å¤è„šæœ¬..."
        if [ -f "fix_tiktok_itms.sh" ]; then
          chmod +x fix_tiktok_itms.sh
          ./fix_tiktok_itms.sh
        else
          echo "âš ï¸ Shellä¿®å¤è„šæœ¬ä¸å­˜åœ¨ï¼Œè·³è¿‡æ­¤æ­¥éª¤"
        fi

    - name: Manual Fix for Common Issues
      run: |
        echo "æ‰‹åŠ¨ä¿®å¤å¸¸è§ITMSé—®é¢˜..." | tee fix_process.log
        
        # ä¿®å¤æ’ä»¶åŠ å¯†é—®é¢˜
        if [ -d "Payload/TikTok.app/PlugIns" ]; then
          echo "å¤„ç†æ’ä»¶åŠ å¯†é—®é¢˜..." | tee -a fix_process.log
          find "Payload/TikTok.app/PlugIns" -name "*.appex" | while read plugin; do
            plugin_name=$(basename "$plugin" .appex)
            binary_path="$plugin/$plugin_name"
            if [ -f "$binary_path" ]; then
              echo "æ£€æŸ¥ $plugin_name..." | tee -a fix_process.log
              # ä¼˜å…ˆä½¿ç”¨optoolï¼Œå¦‚æœä¸å¯ç”¨åˆ™ä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ
              if command -v optool >/dev/null 2>&1; then
                optool uninstall -c load -p LC_ENCRYPTION_INFO -t "$binary_path" 2>/dev/null || echo "optoolå¤„ç†å¤±è´¥ï¼Œç»§ç»­..." | tee -a fix_process.log
                optool uninstall -c load -p LC_ENCRYPTION_INFO_64 -t "$binary_path" 2>/dev/null || echo "optoolå¤„ç†å¤±è´¥ï¼Œç»§ç»­..." | tee -a fix_process.log
              else
                echo "optoolä¸å¯ç”¨ï¼Œä½¿ç”¨otoolæ£€æŸ¥åŠ å¯†çŠ¶æ€..." | tee -a fix_process.log
                otool -l "$binary_path" | grep -A 5 LC_ENCRYPTION_INFO || echo "æ— åŠ å¯†ä¿¡æ¯" | tee -a fix_process.log
              fi
            fi
          done
        fi
        
        # æ£€æŸ¥ä¸»åº”ç”¨äºŒè¿›åˆ¶æ–‡ä»¶
        MAIN_BINARY="Payload/TikTok.app/TikTok"
        if [ -f "$MAIN_BINARY" ]; then
          echo "å¤„ç†ä¸»åº”ç”¨åŠ å¯†é—®é¢˜..." | tee -a fix_process.log
          # ä¼˜å…ˆä½¿ç”¨optoolï¼Œå¦‚æœä¸å¯ç”¨åˆ™ä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ
          if command -v optool >/dev/null 2>&1; then
            optool uninstall -c load -p LC_ENCRYPTION_INFO -t "$MAIN_BINARY" 2>/dev/null || echo "optoolå¤„ç†å¤±è´¥ï¼Œç»§ç»­..." | tee -a fix_process.log
            optool uninstall -c load -p LC_ENCRYPTION_INFO_64 -t "$MAIN_BINARY" 2>/dev/null || echo "optoolå¤„ç†å¤±è´¥ï¼Œç»§ç»­..." | tee -a fix_process.log
          else
            echo "optoolä¸å¯ç”¨ï¼Œä½¿ç”¨otoolæ£€æŸ¥åŠ å¯†çŠ¶æ€..." | tee -a fix_process.log
            otool -l "$MAIN_BINARY" | grep -A 5 LC_ENCRYPTION_INFO || echo "æ— åŠ å¯†ä¿¡æ¯" | tee -a fix_process.log
          fi
        fi
        
        echo "âœ… æ‰‹åŠ¨ä¿®å¤æ­¥éª¤å®Œæˆ" | tee -a fix_process.log

    - name: Verify Fixes
      run: |
        echo "éªŒè¯ä¿®å¤ç»“æœ..." | tee -a fix_process.log
        
        # æ£€æŸ¥Info.plist
        INFO_PLIST="Payload/TikTok.app/Info.plist"
        if [ -f "$INFO_PLIST" ]; then
          echo "âœ… Info.plistä¿®å¤çŠ¶æ€:" >> fix_report.txt
          # ä½¿ç”¨Pythonè¯»å–ç‰ˆæœ¬ä¿¡æ¯
          python3 << 'EOF' >> fix_report.txt
import plistlib
try:
    with open('Payload/TikTok.app/Info.plist', 'rb') as f:
        plist_data = plistlib.load(f)
    version = plist_data.get('MinimumOSVersion', 'æœªè®¾ç½®')
    print(f'   MinimumOSVersion: {version}')
except Exception as e:
    print(f'   è¯»å–å¤±è´¥: {e}')
EOF
        fi
        
        # æ£€æŸ¥ä¸»è¦äºŒè¿›åˆ¶æ–‡ä»¶
        MAIN_BINARY="Payload/TikTok.app/TikTok"
        if [ -f "$MAIN_BINARY" ]; then
          echo "âœ… ä¸»äºŒè¿›åˆ¶æ–‡ä»¶å­˜åœ¨" | tee -a fix_process.log
          file "$MAIN_BINARY" | tee -a fix_process.log
          otool -l "$MAIN_BINARY" | grep -A 5 LC_ENCRYPTION_INFO | tee -a fix_process.log || echo "æ— åŠ å¯†ä¿¡æ¯" | tee -a fix_process.log
        fi
        
        echo "âœ… éªŒè¯å®Œæˆ" | tee -a fix_process.log

    - name: Create Fixed IPA
      run: |
        echo "åˆ›å»ºä¿®å¤åçš„IPAæ–‡ä»¶..." | tee -a fix_process.log
        cd Payload
        zip -r ../TikTok-Fixed.ipa .
        cd ..
        if [ -f "TikTok-Fixed.ipa" ]; then
          ls -la TikTok-Fixed.ipa | tee -a fix_process.log
          echo "âœ… IPAåˆ›å»ºå®Œæˆ" | tee -a fix_process.log
        else
          echo "âŒ IPAåˆ›å»ºå¤±è´¥" | tee -a fix_process.log
        fi

    - name: Generate Fix Report
      run: |
        echo "ç”Ÿæˆä¿®å¤æŠ¥å‘Š..." > fix_report.txt
        echo "=================================" >> fix_report.txt
        echo "TikTok ITMSé”™è¯¯ä¿®å¤æŠ¥å‘Š" >> fix_report.txt
        echo "ä¿®å¤æ—¶é—´: $(date)" >> fix_report.txt
        echo "=================================" >> fix_report.txt
        echo "" >> fix_report.txt
        
        # Info.plistä¿¡æ¯
        INFO_PLIST="Payload/TikTok.app/Info.plist"
        if [ -f "$INFO_PLIST" ]; then
          echo "âœ… Info.plistä¿®å¤çŠ¶æ€:" >> fix_report.txt
          # ä½¿ç”¨Pythonè¯»å–ç‰ˆæœ¬ä¿¡æ¯
          python3 << 'EOF' >> fix_report.txt
import plistlib
try:
    with open('Payload/TikTok.app/Info.plist', 'rb') as f:
        plist_data = plistlib.load(f)
    version = plist_data.get('MinimumOSVersion', 'æœªè®¾ç½®')
    print(f'   MinimumOSVersion: {version}')
except Exception as e:
    print(f'   è¯»å–å¤±è´¥: {e}')
EOF
        fi
        
        echo "" >> fix_report.txt
        echo "âœ… ä¿®å¤å®Œæˆçš„é—®é¢˜:" >> fix_report.txt
        echo "   - ITMS-90208: æœ€å°OSç‰ˆæœ¬å·²æ›´æ–°" >> fix_report.txt
        echo "   - ITMS-90125: å·²å¤„ç†äºŒè¿›åˆ¶åŠ å¯†ä¿¡æ¯" >> fix_report.txt
        echo "   - ITMS-90180: å·²æ£€æŸ¥æ’ä»¶åŠ å¯†èŒƒå›´" >> fix_report.txt
        
        # æ·»åŠ ä¿®å¤ç»Ÿè®¡
        echo "" >> fix_report.txt
        echo "ğŸ“Š ä¿®å¤ç»Ÿè®¡:" >> fix_report.txt
        if [ -f "Payload/TikTok.app/TikTok" ]; then
          echo "   - ä¸»åº”ç”¨äºŒè¿›åˆ¶: å·²å¤„ç†" >> fix_report.txt
        fi
        
        if [ -d "Payload/TikTok.app/PlugIns" ]; then
          plugin_count=$(find "Payload/TikTok.app/PlugIns" -name "*.appex" | wc -l)
          echo "   - æ’ä»¶æ•°é‡: $plugin_count ä¸ª" >> fix_report.txt
        fi
        
        echo "" >> fix_report.txt
        echo "âš ï¸ æ³¨æ„äº‹é¡¹:" >> fix_report.txt
        echo "   - PIEé—®é¢˜éœ€è¦æºç é‡æ–°ç¼–è¯‘" >> fix_report.txt
        echo "   - Frameworkæ®µæƒé™é—®é¢˜éœ€è¦ä¸“ä¸šå·¥å…·" >> fix_report.txt
        echo "   - å»ºè®®ä½¿ç”¨Xcodeè¿›è¡Œæœ€ç»ˆéªŒè¯" >> fix_report.txt
        
        cat fix_report.txt

    - name: Upload Fixed IPA
      uses: actions/upload-artifact@v4
      with:
        name: TikTok-Fixed-IPA
        path: TikTok-Fixed.ipa
        retention-days: 30

    - name: Upload Fix Report
      uses: actions/upload-artifact@v4
      with:
        name: Fix-Report
        path: fix_report.txt
        retention-days: 30

    - name: Upload Logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: Fix-Logs
        path: |
          fix_process.log
          fix_report.txt
        retention-days: 7 