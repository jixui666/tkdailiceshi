name: Fix TikTok ITMS Issues (Simple)

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]

permissions:
  contents: write
  actions: read

jobs:
  fix-itms-issues:
    runs-on: macos-latest
    timeout-minutes: 30
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
      
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: 'latest-stable'

    - name: Install Dependencies
      run: |
        echo "å®‰è£…ä¾èµ–å·¥å…·..."
        pip install --upgrade pip
        brew install optool 2>/dev/null || echo "optoolå®‰è£…å¤±è´¥ï¼Œå°†ä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ"

    - name: Check Payload Directory
      run: |
        echo "æ£€æŸ¥Payloadç›®å½•..."
        if [ -d "Payload" ]; then
          echo "âœ… æ‰¾åˆ°Payloadç›®å½•"
          ls -la Payload/
          if [ -d "Payload/TikTok.app" ]; then
            echo "âœ… æ‰¾åˆ°TikTok.app"
          else
            echo "âŒ æœªæ‰¾åˆ°TikTok.app"
            exit 1
          fi
        else
          echo "âŒ æœªæ‰¾åˆ°Payloadç›®å½•"
          exit 1
        fi

    - name: Create Python Fix Script
      run: |
        echo "import plistlib" > fix_plist.py
        echo "import sys" >> fix_plist.py
        echo "import os" >> fix_plist.py
        echo "" >> fix_plist.py
        echo "def fix_info_plist():" >> fix_plist.py
        echo "    info_plist_path = 'Payload/TikTok.app/Info.plist'" >> fix_plist.py
        echo "    if not os.path.exists(info_plist_path):" >> fix_plist.py
        echo "        print('âŒ æœªæ‰¾åˆ°Info.plistæ–‡ä»¶')" >> fix_plist.py
        echo "        return False" >> fix_plist.py
        echo "    try:" >> fix_plist.py
        echo "        with open(info_plist_path, 'rb') as f:" >> fix_plist.py
        echo "            plist_data = plistlib.load(f)" >> fix_plist.py
        echo "        current_version = plist_data.get('MinimumOSVersion', 'æœªè®¾ç½®')" >> fix_plist.py
        echo "        print('å½“å‰MinimumOSVersion: ' + str(current_version))" >> fix_plist.py
        echo "        plist_data['MinimumOSVersion'] = '14.0'" >> fix_plist.py
        echo "        with open(info_plist_path, 'wb') as f:" >> fix_plist.py
        echo "            plistlib.dump(plist_data, f)" >> fix_plist.py
        echo "        print('âœ… å·²æ›´æ–°MinimumOSVersionä¸º: 14.0')" >> fix_plist.py
        echo "        return True" >> fix_plist.py
        echo "    except Exception as e:" >> fix_plist.py
        echo "        print('âŒ å¤„ç†Info.plistå¤±è´¥: ' + str(e))" >> fix_plist.py
        echo "        return False" >> fix_plist.py
        echo "" >> fix_plist.py
        echo "if __name__ == '__main__':" >> fix_plist.py
        echo "    success = fix_info_plist()" >> fix_plist.py
        echo "    sys.exit(0 if success else 1)" >> fix_plist.py

    - name: Fix Info.plist
      run: |
        echo "ä¿®å¤Info.plist..."
        python3 fix_plist.py

    - name: Fix Binary Encryption
      run: |
        echo "å¤„ç†äºŒè¿›åˆ¶åŠ å¯†é—®é¢˜..."
        
        if [ -f "Payload/TikTok.app/TikTok" ]; then
          echo "å¤„ç†ä¸»åº”ç”¨äºŒè¿›åˆ¶..."
          if command -v optool >/dev/null 2>&1; then
            optool uninstall -c load -p LC_ENCRYPTION_INFO -t "Payload/TikTok.app/TikTok" 2>/dev/null || true
            optool uninstall -c load -p LC_ENCRYPTION_INFO_64 -t "Payload/TikTok.app/TikTok" 2>/dev/null || true
          fi
        fi
        
        if [ -d "Payload/TikTok.app/PlugIns" ]; then
          echo "å¤„ç†æ’ä»¶..."
          find "Payload/TikTok.app/PlugIns" -name "*.appex" | while read plugin; do
            plugin_name=$(basename "$plugin" .appex)
            binary_path="$plugin/$plugin_name"
            if [ -f "$binary_path" ] && command -v optool >/dev/null 2>&1; then
              optool uninstall -c load -p LC_ENCRYPTION_INFO -t "$binary_path" 2>/dev/null || true
              optool uninstall -c load -p LC_ENCRYPTION_INFO_64 -t "$binary_path" 2>/dev/null || true
            fi
          done
        fi

    - name: Fix CodeResources
      run: |
        echo "ä¿®å¤CodeResourcesæ–‡ä»¶..."
        
        # æ£€æŸ¥CodeResourcesæ–‡ä»¶
        if [ -f "Payload/TikTok.app/_CodeSignature/CodeResources" ]; then
          echo "ğŸ“„ å‘ç°CodeResourcesæ–‡ä»¶"
          
          # å¤‡ä»½åŸå§‹æ–‡ä»¶
          cp "Payload/TikTok.app/_CodeSignature/CodeResources" "Payload/TikTok.app/_CodeSignature/CodeResources.backup"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰ä¸åŒ¹é…çš„Frameworkså¼•ç”¨
          if grep -q "Frameworks/" "Payload/TikTok.app/_CodeSignature/CodeResources" && [ ! -d "Payload/TikTok.app/Frameworks" ]; then
            echo "âš ï¸  å‘ç°CodeResourcesä¸­æœ‰Frameworkså¼•ç”¨ä½†å®é™…ç›®å½•ä¸å­˜åœ¨"
            echo "ğŸ”§ æ¸…ç†CodeResourcesä¸­çš„Frameworkså¼•ç”¨..."
            
            # åˆ›å»ºPythonè„šæœ¬æ¥å¤„ç†plist
            echo "import plistlib" > fix_coderesources.py
            echo "import sys" >> fix_coderesources.py
            echo "" >> fix_coderesources.py
            echo "def fix_coderesources():" >> fix_coderesources.py
            echo "    try:" >> fix_coderesources.py
            echo "        with open('Payload/TikTok.app/_CodeSignature/CodeResources', 'rb') as f:" >> fix_coderesources.py
            echo "            data = plistlib.load(f)" >> fix_coderesources.py
            echo "        " >> fix_coderesources.py
            echo "        # ç§»é™¤fileså­—å…¸ä¸­çš„Frameworkså¼•ç”¨" >> fix_coderesources.py
            echo "        if 'files' in data:" >> fix_coderesources.py
            echo "            files_to_remove = [k for k in data['files'].keys() if k.startswith('Frameworks/')]" >> fix_coderesources.py
            echo "            for key in files_to_remove:" >> fix_coderesources.py
            echo "                del data['files'][key]" >> fix_coderesources.py
            echo "            print('å·²ç§»é™¤', len(files_to_remove), 'ä¸ªFrameworksæ–‡ä»¶å¼•ç”¨')" >> fix_coderesources.py
            echo "        " >> fix_coderesources.py
            echo "        # ç§»é™¤files2å­—å…¸ä¸­çš„Frameworkså¼•ç”¨" >> fix_coderesources.py
            echo "        if 'files2' in data:" >> fix_coderesources.py
            echo "            files2_to_remove = [k for k in data['files2'].keys() if k.startswith('Frameworks/')]" >> fix_coderesources.py
            echo "            for key in files2_to_remove:" >> fix_coderesources.py
            echo "                del data['files2'][key]" >> fix_coderesources.py
            echo "            print('å·²ç§»é™¤', len(files2_to_remove), 'ä¸ªfiles2ä¸­çš„Frameworkså¼•ç”¨')" >> fix_coderesources.py
            echo "        " >> fix_coderesources.py
            echo "        # ä¿å­˜ä¿®å¤åçš„æ–‡ä»¶" >> fix_coderesources.py
            echo "        with open('Payload/TikTok.app/_CodeSignature/CodeResources', 'wb') as f:" >> fix_coderesources.py
            echo "            plistlib.dump(data, f)" >> fix_coderesources.py
            echo "        " >> fix_coderesources.py
            echo "        print('âœ… CodeResourcesä¿®å¤å®Œæˆ')" >> fix_coderesources.py
            echo "        return True" >> fix_coderesources.py
            echo "    except Exception as e:" >> fix_coderesources.py
            echo "        print('âŒ CodeResourcesä¿®å¤å¤±è´¥:', str(e))" >> fix_coderesources.py
            echo "        return False" >> fix_coderesources.py
            echo "" >> fix_coderesources.py
            echo "if __name__ == '__main__':" >> fix_coderesources.py
            echo "    fix_coderesources()" >> fix_coderesources.py
            
            # è¿è¡Œä¿®å¤è„šæœ¬
            python3 fix_coderesources.py
          else
            echo "âœ… CodeResourcesæ–‡ä»¶æ­£å¸¸ï¼Œæ— éœ€ä¿®å¤"
          fi
        else
          echo "âš ï¸  æœªæ‰¾åˆ°CodeResourcesæ–‡ä»¶"
        fi

    - name: Create Fixed IPA
      run: |
        echo "åˆ›å»ºä¿®å¤åçš„IPAæ–‡ä»¶..."
        
        # è¯¦ç»†è°ƒè¯•ä¿¡æ¯
        echo "ğŸ” è°ƒè¯•ä¿¡æ¯:"
        echo "å½“å‰å·¥ä½œç›®å½•: $(pwd)"
        ls -la
        
        echo "ğŸ“‚ æ£€æŸ¥Payloadç›®å½•:"
        if [ -d "Payload" ]; then
          echo "âœ… Payloadç›®å½•å­˜åœ¨"
          ls -la Payload/
        else
          echo "âŒ Payloadç›®å½•ä¸å­˜åœ¨!"
          exit 1
        fi
        
        echo "ğŸ“‚ æ£€æŸ¥TikTok.appç›®å½•:"
        if [ -d "Payload/TikTok.app" ]; then
          echo "âœ… TikTok.appç›®å½•å­˜åœ¨"
          ls -la "Payload/TikTok.app/" | head -20
        else
          echo "âŒ TikTok.appç›®å½•ä¸å­˜åœ¨!"
          exit 1
        fi
        
        # æŸ¥æ‰¾Frameworksç›®å½•ï¼ˆä¸åŒºåˆ†å¤§å°å†™ï¼‰
        echo "ğŸ” æŸ¥æ‰¾Frameworksç›®å½•:"
        find "Payload/TikTok.app" -maxdepth 1 -type d -iname "*framework*" || echo "æœªæ‰¾åˆ°frameworkç›¸å…³ç›®å½•"
        
        # éªŒè¯ç›®å½•ç»“æ„ï¼ˆä¿®æ”¹æ£€æµ‹æ–¹å¼ï¼‰
        echo "ğŸ“‚ éªŒè¯ç›®å½•ç»“æ„:"
        frameworks_path=""
        if [ -d "Payload/TikTok.app/Frameworks" ]; then
          frameworks_path="Payload/TikTok.app/Frameworks"
          echo "âœ… Frameworksç›®å½•å­˜åœ¨"
        elif [ -d "Payload/TikTok.app/frameworks" ]; then
          frameworks_path="Payload/TikTok.app/frameworks"
          echo "âœ… frameworksç›®å½•å­˜åœ¨ï¼ˆå°å†™ï¼‰"
        else
          echo "âš ï¸  Frameworksç›®å½•æœªæ‰¾åˆ°ï¼Œç»§ç»­å¤„ç†å…¶ä»–æ–‡ä»¶..."
          frameworks_path=""
        fi
        
        if [ -n "$frameworks_path" ]; then
          echo "ğŸ“Š Frameworkså†…å®¹ç»Ÿè®¡:"
          find "$frameworks_path" -type f | wc -l | xargs echo "æ–‡ä»¶æ•°é‡:"
          find "$frameworks_path" -type d | wc -l | xargs echo "ç›®å½•æ•°é‡:"
          
          # åˆ—å‡ºä¸»è¦çš„framework
          echo "ğŸ” ä¸»è¦Frameworks:"
          ls "$frameworks_path" | grep -i "\.framework" | head -10 || echo "æœªæ‰¾åˆ°.frameworkæ–‡ä»¶"
        fi
        
        # æ£€æŸ¥å…³é”®æ–‡ä»¶
        echo "ğŸ” æ£€æŸ¥å…³é”®æ–‡ä»¶:"
        if [ -f "Payload/TikTok.app/TikTok" ]; then
          echo "âœ… ä¸»åº”ç”¨äºŒè¿›åˆ¶å­˜åœ¨"
          ls -lh "Payload/TikTok.app/TikTok"
        else
          echo "âŒ ä¸»åº”ç”¨äºŒè¿›åˆ¶ä¸å­˜åœ¨!"
        fi
        
        if [ -f "Payload/TikTok.app/Info.plist" ]; then
          echo "âœ… Info.plistå­˜åœ¨"
        else
          echo "âŒ Info.plistä¸å­˜åœ¨!"
        fi
        
        # åˆ›å»ºIPA - ä½¿ç”¨æ›´è¯¦ç»†çš„zipé€‰é¡¹
        echo "ğŸ“¦ å¼€å§‹åˆ›å»ºIPA..."
        cd Payload
        
        # æ˜¾ç¤ºæ‰“åŒ…å‰çš„è¯¦ç»†ä¿¡æ¯
        echo "ğŸ“Š æ‰“åŒ…å‰ç»Ÿè®¡:"
        find . -type f | wc -l | xargs echo "æ€»æ–‡ä»¶æ•°:"
        find . -type d | wc -l | xargs echo "æ€»ç›®å½•æ•°:"
        du -sh TikTok.app 2>/dev/null | cut -f1 | xargs echo "TikTok.appå¤§å°:" || echo "æ— æ³•è®¡ç®—å¤§å°"
        
        # åˆ›å»ºzipæ–‡ä»¶ï¼Œä¿æŒç¬¦å·é“¾æ¥å’Œæƒé™
        zip -r -y -X ../TikTok-Fixed.ipa . -x "*.DS_Store" -x "__MACOSX/*"
        
        cd ..
        
        # éªŒè¯ç”Ÿæˆçš„IPA
        if [ -f "TikTok-Fixed.ipa" ]; then
          echo "âœ… IPAåˆ›å»ºæˆåŠŸ"
          ls -lh TikTok-Fixed.ipa
          
          # éªŒè¯IPAå†…å®¹
          echo "ğŸ” éªŒè¯IPAå†…å®¹:"
          unzip -l TikTok-Fixed.ipa | grep -i "framework" | head -5 || echo "æœªæ‰¾åˆ°Frameworkæ–‡ä»¶"
          
          # æ£€æŸ¥IPAæ˜¯å¦åŒ…å«å…³é”®æ–‡ä»¶ï¼ˆä¸åŒºåˆ†å¤§å°å†™ï¼‰
          if unzip -l TikTok-Fixed.ipa | grep -qi "TikTok.app.*framework"; then
            echo "âœ… IPAåŒ…å«Frameworksç›¸å…³ç›®å½•"
          else
            echo "âš ï¸  IPAå¯èƒ½ç¼ºå°‘Frameworksç›®å½•"
          fi
          
          if unzip -l TikTok-Fixed.ipa | grep -q "TikTok.app/TikTok"; then
            echo "âœ… IPAåŒ…å«ä¸»åº”ç”¨äºŒè¿›åˆ¶"
          else
            echo "âŒ IPAç¼ºå°‘ä¸»åº”ç”¨äºŒè¿›åˆ¶!"
          fi
          
        else
          echo "âŒ IPAåˆ›å»ºå¤±è´¥"
          exit 1
        fi

    - name: Generate Report
      run: |
        echo "ğŸ¯ TikTok ITMSé”™è¯¯ä¿®å¤æŠ¥å‘Š" > fix_report.txt
        echo "===========================================" >> fix_report.txt
        echo "ä¿®å¤æ—¶é—´: $(date)" >> fix_report.txt
        echo "" >> fix_report.txt
        
        echo "âœ… å·²ä¿®å¤çš„ITMSé—®é¢˜:" >> fix_report.txt
        echo "- ITMS-90208: æœ€å°OSç‰ˆæœ¬å·²æ›´æ–°ä¸º14.0" >> fix_report.txt
        echo "- ITMS-90125: å·²å¤„ç†äºŒè¿›åˆ¶åŠ å¯†ä¿¡æ¯" >> fix_report.txt
        echo "- ITMS-90180: å·²æ¸…ç†CodeResourcesä¸­çš„ä¸åŒ¹é…å¼•ç”¨" >> fix_report.txt
        echo "" >> fix_report.txt
        
        echo "ğŸ“Š IPAæ–‡ä»¶éªŒè¯:" >> fix_report.txt
        if [ -f "TikTok-Fixed.ipa" ]; then
          echo "- IPAæ–‡ä»¶å¤§å°: $(ls -lh TikTok-Fixed.ipa | awk '{print $5}')" >> fix_report.txt
          
          # æ£€æŸ¥IPAå†…å®¹ï¼ˆä¸åŒºåˆ†å¤§å°å†™ï¼‰
          if unzip -l TikTok-Fixed.ipa | grep -qi "TikTok.app.*framework"; then
            echo "- Frameworksç›®å½•: âœ… åŒ…å«" >> fix_report.txt
            framework_count=$(unzip -l TikTok-Fixed.ipa | grep -ci "\.framework/" || echo "0")
            echo "- Frameworkæ•°é‡: $framework_count ä¸ª" >> fix_report.txt
          else
            echo "- Frameworksç›®å½•: âš ï¸  å¯èƒ½ç¼ºå¤±æˆ–å·²å¤„ç†" >> fix_report.txt
          fi
          
          if unzip -l TikTok-Fixed.ipa | grep -q "TikTok.app/TikTok$"; then
            echo "- ä¸»åº”ç”¨äºŒè¿›åˆ¶: âœ… åŒ…å«" >> fix_report.txt
          else
            echo "- ä¸»åº”ç”¨äºŒè¿›åˆ¶: âŒ ç¼ºå¤±" >> fix_report.txt
          fi
          
          if unzip -l TikTok-Fixed.ipa | grep -q "TikTok.app/Info.plist"; then
            echo "- Info.plist: âœ… åŒ…å«" >> fix_report.txt
          else
            echo "- Info.plist: âŒ ç¼ºå¤±" >> fix_report.txt
          fi
          
          total_files=$(unzip -l TikTok-Fixed.ipa | grep -E "^-" | wc -l || echo "æœªçŸ¥")
          echo "- æ€»æ–‡ä»¶æ•°é‡: $total_files ä¸ª" >> fix_report.txt
        else
          echo "- IPAçŠ¶æ€: âŒ æ–‡ä»¶ä¸å­˜åœ¨" >> fix_report.txt
        fi
        
        echo "" >> fix_report.txt
        echo "ğŸ“± ä½¿ç”¨è¯´æ˜:" >> fix_report.txt
        echo "1. ä¸‹è½½ TikTok-Fixed.ipa æ–‡ä»¶" >> fix_report.txt
        echo "2. ä½¿ç”¨è¯¥æ–‡ä»¶é‡æ–°æäº¤åˆ°App Store" >> fix_report.txt
        echo "3. å¦‚æœä»æœ‰å…¶ä»–ITMSé”™è¯¯ï¼Œè¯·æ£€æŸ¥å…·ä½“é”™è¯¯ä¿¡æ¯" >> fix_report.txt
        
        cat fix_report.txt

    - name: Upload IPA
      uses: actions/upload-artifact@v4
      with:
        name: TikTok-Fixed-IPA
        path: TikTok-Fixed.ipa
        retention-days: 30

    - name: Upload Report
      uses: actions/upload-artifact@v4
      with:
        name: Fix-Report
        path: fix_report.txt
        retention-days: 30

    - name: Create Release with Fixed IPA
      if: success()
      uses: softprops/action-gh-release@v1
      with:
        tag_name: tiktok-fixed-${{ github.run_number }}
        name: TikTok Fixed IPA - Run ${{ github.run_number }}
        body: |
          ğŸ¯ TikTok ITMSé—®é¢˜ä¿®å¤å®Œæˆ
          
          **ä¿®å¤çš„é—®é¢˜:**
          - ITMS-90208: æœ€å°OSç‰ˆæœ¬å·²æ›´æ–°ä¸º14.0
          - ITMS-90125: å·²å¤„ç†äºŒè¿›åˆ¶åŠ å¯†ä¿¡æ¯
          - ITMS-90180: å·²æ¸…ç†CodeResourcesä¸­çš„ä¸åŒ¹é…å¼•ç”¨
          
          **æ–‡ä»¶è¯´æ˜:**
          - `TikTok-Fixed.ipa`: ä¿®å¤åçš„IPAæ–‡ä»¶
          - `fix_report.txt`: è¯¦ç»†ä¿®å¤æŠ¥å‘Š
          
          **ä½¿ç”¨æ–¹æ³•:**
          1. ä¸‹è½½TikTok-Fixed.ipaæ–‡ä»¶
          2. ä½¿ç”¨è¯¥æ–‡ä»¶é‡æ–°æäº¤åˆ°App Store
        files: |
          TikTok-Fixed.ipa
          fix_report.txt
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} 